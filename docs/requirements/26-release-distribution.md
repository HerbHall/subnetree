## Release & Distribution

### CI/CD Pipeline (GitHub Actions)

| Trigger | Workflow | Steps |
|---------|----------|-------|
| Every PR | `ci.yml` | Lint (golangci-lint), test (race detector), build snapshot, license check |
| Push to `main` | `ci.yml` | Same as PR + integration tests |
| Tag `v*` | `release.yml` | Full release: GoReleaser, Docker build+push, SBOM, signing, changelog |

### Build Tooling

- **GoReleaser:** Cross-platform binary builds from tagged releases
- **Targets:** `linux/amd64`, `linux/arm64`, `windows/amd64`, `darwin/arm64`
- **Snapshot builds:** GoReleaser `--snapshot` on PRs for build verification

### Release Artifacts

| Artifact | Format | Signed | Description |
|----------|--------|--------|-------------|
| Server binaries | tar.gz / zip | Cosign | Per-platform server binaries |
| Agent binaries | tar.gz / zip | Cosign | Per-platform Scout binaries |
| Docker images | OCI | Cosign | Multi-arch manifest, GitHub Container Registry |
| Checksums | SHA256 | Cosign | `checksums.txt` with detached signature |
| SBOM | SPDX JSON | Cosign | Syft-generated software bill of materials |
| Changelog | Markdown | -- | Auto-generated from conventional commits |
| SLSA Provenance | JSON (intoto) | -- | Build provenance attestation (Phase 2) |

### Supply Chain Security

- **Binary signing:** Cosign keyless signing (Sigstore) for all release binaries and Docker images
- **SBOM:** Generated by Syft at build time, attached to GitHub Release and Docker image
- **Vulnerability scanning:** `govulncheck` for Go dependencies, Trivy for Docker images, run in CI on every PR
- **Dependency audit:** `go-licenses` checks for incompatible licenses on every PR
- **Reproducible builds:** Go's deterministic compilation with pinned toolchain version

### Version Management

All version strings follow **Semantic Versioning 2.0.0** (`MAJOR.MINOR.PATCH`) with optional pre-release suffixes. This section is the single source of truth for how versioning works across all NetVantage components. Component-specific enforcement rules are documented inline in the relevant sections (Plugin Lifecycle, Agent-Server Compatibility, REST API Standards, gRPC Services, Configuration).

#### Component Version Inventory

| Component | Version Format | Where Defined | How Consumed |
|-----------|---------------|---------------|--------------|
| Server binary | SemVer (`1.3.2`) | Build-time ldflags | `--version` flag, `/api/v1/health`, `X-NetVantage-Version` header, logs |
| Scout agent binary | SemVer (`1.3.2`) | Build-time ldflags | `--version` flag, `CheckInRequest.agent_version`, logs |
| Plugin API | Integer (`1`, `2`, ...) | `PluginAPIVersionCurrent` constant | `PluginInfo.APIVersion`, registry validation at startup |
| Individual plugins | SemVer (`0.4.1`) | Build-time ldflags (per module) | `PluginInfo.Version`, `/api/v1/plugins` response |
| REST API | Integer in URL path (`v1`) | URL prefix `/api/v1/` | Client requests, `Sunset`/`Deprecation` headers on deprecated versions |
| gRPC API | Integer (`1`, `2`, ...) | Proto package (`netvantage.v1`) | `CheckInRequest.proto_version`, `buf breaking` CI check |
| Database schema | Integer per plugin (`1`, `2`, ...) | `_migrations` table | Automatic forward-only migration at startup |
| Configuration format | Integer (`1`, `2`, ...) | `config_version` YAML field | Startup validation, `netvantage config migrate` CLI |
| Plugin SDK packages | SemVer via Go module | `pkg/plugin/`, `pkg/roles/`, `pkg/models/` | Go module versioning (same repo, tagged independently when needed) |

#### SemVer Rules for Server and Agent

- **MAJOR** bump: Breaking changes to REST API contract, gRPC protocol, Plugin API (dropping an old `APIVersion`), or configuration format (incrementing `config_version`). Users must take action.
- **MINOR** bump: New features, new API endpoints, new optional config keys, new optional plugin interfaces. Backward compatible. No user action required.
- **PATCH** bump: Bug fixes, security patches, performance improvements. No new features. No user action required.
- **Pre-release:** `v1.0.0-alpha.1`, `v1.0.0-beta.1`, `v1.0.0-rc.1`. Pre-release versions have no stability guarantees and are used for testing only.
- **Changelog:** Auto-generated from conventional commit messages (`feat:`, `fix:`, `refactor:`, etc.) by GoReleaser.

#### Build-Time Version Injection

Version information is injected at compile time via Go `ldflags`. No version string is hardcoded in source code.

**Version variables** (in `internal/version/version.go`):

```go
package version

// Set at build time via ldflags. Do not edit.
var (
    Version   = "dev"       // SemVer string, e.g., "1.3.2"
    GitCommit = "unknown"   // Short SHA of the build commit
    BuildDate = "unknown"   // RFC 3339 build timestamp
    GoVersion = "unknown"   // Go toolchain version
)
```

**Makefile pattern:**

```makefile
VERSION   ?= $(shell git describe --tags --always --dirty)
COMMIT    ?= $(shell git rev-parse --short HEAD)
DATE      ?= $(shell date -u +%Y-%m-%dT%H:%M:%SZ)
GOVERSION ?= $(shell go version | awk '{print $$3}')

VERSION_PKG = github.com/HerbHall/netvantage/internal/version
LDFLAGS = -ldflags "-s -w \
  -X $(VERSION_PKG).Version=$(VERSION) \
  -X $(VERSION_PKG).GitCommit=$(COMMIT) \
  -X $(VERSION_PKG).BuildDate=$(DATE) \
  -X $(VERSION_PKG).GoVersion=$(GOVERSION)"
```

**`--version` flag output** (both server and agent):

```
netvantage version 1.3.2 (commit: a1b2c3d, built: 2025-07-15T14:30:00Z, go: go1.25.6)
```

**Plugin versions:** Each built-in plugin's `Version()` method returns `version.Version` (the server version), since built-in plugins ship with the server binary. Third-party plugins compiled separately inject their own version via their own build's ldflags.

#### Plugin SDK Versioning

The Plugin SDK (`pkg/plugin/`, `pkg/roles/`, `pkg/models/`) is Apache 2.0 licensed and lives in the same Git repository as the BSL-licensed core. It versions as follows:

- **Go module path:** `github.com/HerbHall/netvantage` (same module). SDK packages are importable as `github.com/HerbHall/netvantage/pkg/plugin`, etc.
- **Version coupling (Phase 1-2):** During early development, SDK packages version with the server. A server release `v1.3.2` means `pkg/plugin/` is also at `v1.3.2`. This is the standard Go monorepo pattern.
- **Independent versioning (Phase 3+):** If the SDK needs to release independently (e.g., SDK bugfix without server release), split to a Go sub-module (`pkg/plugin/go.mod`). This is deferred until there is actual demand from third-party plugin developers.
- **API stability promise:** Within a major version, the SDK's exported types and interfaces are backward compatible. New optional interfaces are additive. Removing or changing existing interfaces is a major version bump.

#### Version Compatibility Matrix

Single reference table for what must be compatible with what.

| When this changes... | ...check compatibility with | Rule |
|----------------------|-----------------------------|------|
| Server major version | REST API clients | REST API version may increment. Deprecated API removed after 6 months / 2 minors. |
| Server major version | Scout agents | `proto_version` may increment. Agents at N-1 still accepted. Agents at N-2 or older rejected. |
| Server major version | Plugins | `PluginAPIVersionMin` may increment (drop old API). Plugins must target `>= Min`. |
| Server major version | Config files | `config_version` may increment. Old configs get migration warning + CLI migration tool. |
| Server major version | Database schema | Forward-only migrations run automatically. Backup before upgrade. No rollback. |
| Server minor version | Everything above | Backward compatible. No breaking changes. New features are additive. |
| Plugin API version | Third-party plugins | Plugin targets a single `APIVersion` integer. Server accepts `[Min, Current]` range. |
| gRPC proto version | Scout agents | Integer-based negotiation at check-in. Server supports N and N-1. |
| REST API version | Dashboard, external clients | URL path changes (`/api/v2/`). Old path returns `Sunset` header for 6 months. |
| Plugin's own version | Nothing external | Plugin version is informational (displayed in UI, logged). No compatibility enforcement between plugins. |
| SDK package changes | Third-party plugin source code | Standard Go module compatibility. Additive within major. |

#### Version Mismatch Error Strategy

All version mismatches produce **explicit, actionable error messages**. No silent failures.

| Mismatch | Detection Point | Behavior |
|----------|----------------|----------|
| Plugin API too old | Server startup (registry validation) | Server refuses to load plugin. Error logged with versions and upgrade instructions. |
| Plugin API too new | Server startup (registry validation) | Server refuses to load plugin. Error logged with "upgrade server" message. |
| Agent proto too old | Agent check-in (gRPC handler) | Check-in rejected (`VERSION_REJECTED`). Agent logs upgrade message. Server logs event. |
| Agent proto too new | Agent check-in (gRPC handler) | Check-in rejected (`VERSION_REJECTED`). Agent logs downgrade/wait message. Server logs event. |
| Config version too new | Server startup (config load) | Server refuses to start. Error with "upgrade server or downgrade config" message. |
| Config version too old | Server startup (config load) | Server starts with warning. Suggests `netvantage config migrate`. |
| REST API version removed | Client HTTP request | HTTP 410 Gone with `Sunset` header and message pointing to new API version. |
| Database schema too new | Server startup (migration check) | Server refuses to start. "Database was created by a newer server version." |
